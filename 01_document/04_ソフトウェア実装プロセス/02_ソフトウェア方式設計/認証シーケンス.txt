@startuml
title 認証シーケンス(永井作成)
' Participants
actor User as user

box "フロントエンド\nアプリケーション" #ACB9CA
    participant "HTML" as html
    participant "JavaScript" as js
end box

box "バックエンド\nアプリケーション" #B4C6E7
    participant "IdentityManagement" as idm
    participant "PythonScript" as py
end box

box "データベース" #FFE699
    participant "MySQL" as db
end box

'Sequence
== ログイン/スマートカードログイン共通シーケンス図 ==
    activate user
    activate html
    activate js
    activate idm
idm -> idm : ユーザー名/パスワード\nバリデーション
opt バリデーション失敗
    idm --> js : 失敗応答
end
idm -> db : ユーザー情報取得問合せ
    activate db
db --> idm : ユーザー情報
    deactivate db
idm -> idm : 認証
idm --> html : CSRF(クロスサイトリクエストフォージェリ)\n対策のトークンをブラウザのCookieに書き込む
idm --> js : ログイン処理応答
    deactivate idm

alt 成功応答
  js -> js : ユーザー情報保持
  js --> html :ユーザー情報
  html -> html : 共通画面遷移
  html --> user : 共通画面表示
else 失敗応答
  js --> html : エラーメッセージ
      deactivate js
  html -> html : エラーメッセージ表示
  html --> user : ログイン失敗
      deactivate html
      deactivate user
end


== ログイン ==
user -> html : ユーザー名入力
    note right : 初期画面は認証画面
    activate user
    activate html
user -> html : パスワード入力
user -> html : ログインボタン押下
html -> js :ユーザー名/パスワード
    activate js
js -> js : ユーザー名/パスワード\nバリデーション
opt バリデーション失敗
    js --> html : エラーメッセージ
    html -> html : エラーメッセージ表示
    html --> user : ログイン失敗
end
js -> idm : ログイン処理要求\n(ユーザー名/パスワード)
    activate idm
    deactivate html
    deactivate user
    deactivate idm
    deactivate js
ref over user, db : ログイン/スマートカードログイン共通シーケンス図


== スマートカード読み取り失敗 ==
js -> js : 失敗原因確認
    activate user
    activate html
    activate js

note right : バックエンドからの応答のBodyで判断する
alt 読み取り時間超過
    js --> html : エラーメッセージおよび再実行ボタン表示
    html -> html : 画面更新
    html --> user : エラーメッセージおよび再実行ボタン表示
    note right : スマートカード読み取りに失敗しました。\n再度スマートカード読み取りしますか?
    opt 再実行ボタン押下
        user -> html : 再実行ボタン押下
        note right : スマートカードログインと重複するので略
    end
else スマートカード登録がされていないまたは、その他装置エラーなど
    js --> html : エラーメッセージ表示
        deactivate js
    html -> html : 画面更新
    html --> user : エラーメッセージ表示
        deactivate html
        deactivate user
    note right : e.g.\nスマートカードが登録されていません。管理者に連絡してください。\nカードリーダにエラーがが発生しました。管理者に連絡してください。
end

== スマートカードログイン ==
user -> html : スマートカードログインボタン押下
    activate user
    activate html
    note right : 初期画面は認証画面
html -> html : スマートカードログイン画面遷移
html -> user : スマートカードログイン画面\n「カードを置いてください」メッセージ
html -> js :
    activate js
js -> idm : スマートカードログイン
    activate idm
idm -> py : スマートカード番号読み取り命令
    activate py
alt ユーザーが3秒以内にスマートカードをカードリーダに載せる
    user -> user : スマートカードをカードリーダに載せる
    py --> idm : カード番号検知
        deactivate py
    idm -> db : カード番号からユーザー名/パスワード取得
        activate db
    db --> idm : ユーザー名/パスワード
        deactivate db
    alt ユーザー名/パスワード取得成功
        ref over user, db : ログイン/スマートカードログイン共通シーケンス図
    else カード番号とユーザーが紐づいていない
        idm --> js : 失敗応答
        ref over user, js : スマートカード読み取り失敗
    end
else ユーザーが3秒以内にスマートカードをカードリーダに載せない
    idm -> idm : タイムアウト判定

    idm --> js : 失敗応答
    deactivate js
    deactivate html
    deactivate user
    deactivate idm
    ref over user, js : スマートカード読み取り失敗
end


== ログアウト ==
user -> html : ログアウトボタン押下
    activate user
    activate html
html -> js :
    activate js
js -> idm : ログアウト要求\n(認証トークン)
    activate idm
alt 認証トークン有効
    idm -> idm : トークン破棄
    idm -> html : ブラウザに保存されているCookieを破棄
    idm --> js : ログアウト成功応答
else 認証トークン無効
    idm --> js : トークン無効応答
        deactivate idm
end
js -> html :
    deactivate js
html -> html : ログアウト画面表示
html --> user : ログアウト画面表示
    deactivate html
    deactivate user

@enduml
